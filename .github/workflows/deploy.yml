name: Deploy SkillMap Engine

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 0
  COMPOSE_DOCKER_CLI_BUILD: 0

jobs:
  deploy:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy SkillMap Engine
      run: |
        set -e
        
        echo "ğŸš€ Starting deployment process..."
        
        # Navigate to project directory
        cd ${{ github.workspace }}
        
        # Copy .env file from main project if it doesn't exist
        if [ ! -f .env ]; then
          echo "ğŸ“„ Copying .env file from main project..."
          cp /home/aahil/projects/skillmap_engine/.env .env || echo "Could not copy .env file"
        fi
        
        # Backup current .env file
        cp .env .env.backup || echo "No .env file to backup"
        
        # Kill container processes directly via PID to avoid Docker permission issues
        echo "âš¡ Force killing existing container processes..."
        CONTAINER_PIDS=$(docker ps -q --filter "name=skillmap" | xargs -I {} docker inspect --format '{{.State.Pid}}' {} 2>/dev/null || true)
        if [ ! -z "$CONTAINER_PIDS" ]; then
          echo "Found container PIDs: $CONTAINER_PIDS"
          echo $CONTAINER_PIDS | xargs -r kill -9 || true
          sleep 2
        fi
        
        # Remove any remaining container references
        docker ps -aq --filter "name=skillmap" | xargs -r docker rm -f || true
        
        # Remove old images and containers to free up space
        echo "ğŸ§¹ Cleaning up old Docker resources..."
        docker system prune -f --volumes || true
        
        # Build and start containers
        echo "ğŸ”¨ Building and starting containers..."
        docker-compose up --build -d --remove-orphans
        
        # Wait for containers to be ready
        echo "â³ Waiting for containers to start..."
        sleep 30
        
        # Check container health
        echo "ğŸ¥ Checking container health..."
        docker-compose ps
        
        # Test health endpoint
        echo "ğŸ” Testing health endpoint..."
        for i in {1..5}; do
          if curl -f http://localhost:5005/health > /dev/null 2>&1; then
            echo "âœ… Health check passed!"
            break
          else
            echo "âŒ Health check failed, attempt $i/5"
            if [ $i -eq 5 ]; then
              echo "ğŸš¨ Health check failed after 5 attempts"
              docker-compose logs --tail=50
              exit 1
            fi
            sleep 10
          fi
        done
        
        # Show recent logs
        echo "ğŸ“‹ Recent logs:"
        docker-compose logs --tail=20
        
        echo "ğŸ‰ Deployment completed successfully!"
