name: Deploy SkillMap Engine

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 0
  COMPOSE_DOCKER_CLI_BUILD: 0

jobs:
  deploy:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy SkillMap Engine
      run: |
        set -e
        
        echo "🚀 Starting deployment process..."
        
        # Navigate to project directory
        cd ${{ github.workspace }}
        
        # Copy .env file from main project if it doesn't exist
        if [ ! -f .env ]; then
          echo "📄 Copying .env file from main project..."
          cp /home/aahil/projects/skillmap_engine/.env .env || echo "Could not copy .env file"
        fi
        
        # Backup current .env file
        cp .env .env.backup || echo "No .env file to backup"
        
        # Force stop all skillmap-related processes
        echo "⚡ Force stopping all skillmap processes..."
        # Get container IDs and their PIDs
        CONTAINER_IDS=$(sudo docker ps -aq --filter "name=skillmap")
        if [ ! -z "$CONTAINER_IDS" ]; then
          echo "Found containers: $CONTAINER_IDS"
          for container in $CONTAINER_IDS; do
            PID=$(sudo docker inspect $container --format '{{.State.Pid}}' 2>/dev/null)
            if [ ! -z "$PID" ] && [ "$PID" != "0" ]; then
              echo "Killing container $container with PID $PID"
              sudo /usr/bin/kill -9 $PID 2>/dev/null || true
            fi
          done
          # Wait for processes to die
          sleep 3
        fi
        
        # Remove all skillmap containers forcefully
        echo "Removing all skillmap containers..."
        sudo docker ps -aq --filter "name=skillmap" | xargs -r sudo docker rm -f 2>/dev/null || true
        sudo docker container prune -f 2>/dev/null || true
        
        # Remove old images and containers to free up space
        echo "🧹 Cleaning up old Docker resources..."
        sudo docker system prune -f --volumes || true
        
        # Build and start containers (this will handle stopping existing ones)
        echo "🔨 Building and starting containers..."
        sudo docker-compose up --build -d --remove-orphans
        
        # Wait for containers to be ready
        echo "⏳ Waiting for containers to start..."
        sleep 30
        
        # Check container health
        echo "🏥 Checking container health..."
        sudo docker-compose ps
        
        # Test health endpoint
        echo "🔍 Testing health endpoint..."
        for i in {1..5}; do
          if curl -f http://localhost:5005/health > /dev/null 2>&1; then
            echo "✅ Health check passed!"
            break
          else
            echo "❌ Health check failed, attempt $i/5"
            if [ $i -eq 5 ]; then
              echo "🚨 Health check failed after 5 attempts"
              sudo docker-compose logs --tail=50
              exit 1
            fi
            sleep 10
          fi
        done
        
        # Show recent logs
        echo "📋 Recent logs:"
        sudo docker-compose logs --tail=20
        
        echo "🎉 Deployment completed successfully!"
